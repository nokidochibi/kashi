<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>aikoã®æ­Œè©ã¨ã‹èª¿ã¹ã‚‹ã‚„ã¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; transition: background-color 0.3s ease, color 0.3s ease; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .send-btn-active:active { transform: scale(0.9); }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        
        .pulse-text { animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }

        .message-row { scroll-margin-top: 6rem; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }

        .highlight-text {
            color: #ea580c;
            font-weight: bold;
            background-color: #fff7ed;
            padding: 0 2px;
            border-radius: 2px;
        }

        /* å¹ãå‡ºã— (Default) */
        .bubble { position: relative; border-radius: 1.2rem; transition: background-color 0.3s, color 0.3s; }
        .bubble-right::before {
            content: ""; position: absolute; top: 10px; right: -8px; width: 0; height: 0;
            border-style: solid; border-width: 6px 0 6px 10px;
            border-color: transparent transparent transparent var(--bubble-color, #f97316);
        }
        .bubble-left::before {
            content: ""; position: absolute; top: 10px; left: -8px; width: 0; height: 0;
            border-style: solid; border-width: 6px 10px 6px 0;
            border-color: transparent #ffffff transparent transparent;
        }

        /* ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
        .tab-btn {
            border-top-width: 3px; 
            border-bottom-width: 0;
            border-color: transparent;
            transition: all 0.3s;
            opacity: 0.5;
            color: #9ca3af;
        }
        .tab-btn.active {
            font-weight: bold;
            opacity: 1;
            background-color: #f9fafb;
        }
        
        /* é€šå¸¸ãƒ†ãƒ¼ãƒè¨­å®š */
        .theme-lyrics .tab-btn.active[data-tab="lyrics"] { border-color: #f97316; color: #f97316; }
        .theme-title .tab-btn.active[data-tab="title"] { border-color: #0ea5e9; color: #0ea5e9; }
        
        .theme-lyrics .text-theme { color: #f97316; }
        .theme-lyrics .bg-theme { background-color: #f97316; }
        .theme-lyrics .bg-theme-soft { background-color: #fff7ed; }
        .theme-lyrics .border-theme { border-color: #ffedd5; }

        .theme-title .text-theme { color: #0ea5e9; }
        .theme-title .bg-theme { background-color: #0ea5e9; }
        .theme-title .bg-theme-soft { background-color: #f0f9ff; }
        .theme-title .border-theme { border-color: #e0f2fe; }

        .theme-shiritori .text-theme { color: #ec4899; }
        .theme-shiritori .bg-theme { background-color: #ec4899; }
        .theme-shiritori .bg-theme-soft { background-color: #fdf2f8; }
        .theme-shiritori .border-theme { border-color: #fce7f3; }

        /* =========================================
           â˜…ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ (è£ãƒ¢ãƒ¼ãƒ‰)
           ========================================= */
        body.dark-mode {
            background-color: #0f172a; /* Slate-900 */
            color: #e2e8f0; /* Slate-200 */
        }
        body.dark-mode header,
        body.dark-mode footer {
            background-color: #1e293b; /* Slate-800 */
            border-color: #334155; /* Slate-700 */
        }
        body.dark-mode .tab-btn.active {
            background-color: #334155;
        }
        /* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ å‘¨ã‚Š */
        body.dark-mode #search-form .bg-gray-100 {
            background-color: #334155;
            border-color: #475569;
        }
        body.dark-mode input {
            color: #fff;
        }
        /* å¹ãå‡ºã— (Bot) */
        body.dark-mode .bubble-left {
            background-color: #334155;
            color: #f1f5f9;
        }
        body.dark-mode .bubble-left::before {
            border-color: transparent #334155 transparent transparent;
        }
        /* Botã‚¢ã‚¤ã‚³ãƒ³ */
        body.dark-mode .bot-icon {
            border-color: #475569;
            background-color: #1e293b;
        }
        /* ãƒ©ãƒ³ãƒ€ãƒ ã‚¨ãƒªã‚¢ */
        body.dark-mode #random-lyric-container {
            background-color: #1e293b;
            border-color: #334155;
        }
        /* ã—ã‚Šã¨ã‚Šãƒœã‚¿ãƒ³ */
        body.dark-mode button.bg-white {
            background-color: #1e293b;
            border-color: #ec4899; /* Pink */
            color: #fbcfe8; /* Pink-200 */
        }
        body.dark-mode button.bg-white:hover {
            background-color: #334155;
        }

        /* è£ãƒ¢ãƒ¼ãƒ‰ä¸­ã¯ãƒ•ãƒƒã‚¿ãƒ¼ã®ã‚¿ãƒ–ã‚¨ãƒªã‚¢ã‚’éš ã™ã‚¹ã‚¿ã‚¤ãƒ« */
        body.dark-mode #footer-tab-area {
            display: none;
        }

        :root {
            --bubble-color: #f97316;
        }

        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: opacity 0.2s ease-out, transform 0.2s ease-out; }
    </style>
</head>
<body id="app-body" class="bg-orange-50 text-gray-800 h-screen flex flex-col theme-lyrics transition-colors duration-300">

    <header class="bg-white/95 backdrop-blur-sm shadow-sm flex flex-col items-center justify-center sticky top-0 z-20 border-b border-theme relative transition-colors duration-300 h-14">
        <div class="w-full flex items-center justify-center relative">
            <!-- â˜…ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆ -->
            <h1 id="app-title" ondblclick="activateSecretMode()" class="text-lg font-bold text-theme tracking-wider flex items-baseline transition-colors duration-300 select-none cursor-pointer active:scale-95 transition-transform">
                aikoã®æ­Œè©ã¨ã‹èª¿ã¹ã‚‹ã‚„ã¤
                <span id="version-display" class="ml-2 text-[10px] text-gray-400 font-normal opacity-50"></span>
            </h1>
            <button onclick="toggleModal(true)" class="absolute right-4 text-gray-400 hover:text-theme transition p-1 rounded-full hover:bg-gray-50">
                <i data-lucide="help-circle" class="w-6 h-6"></i>
            </button>
        </div>
    </header>

    <!-- 1. æ­Œè©ãƒãƒ£ãƒƒãƒˆ -->
    <main id="chat-container-lyrics" class="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar pb-64"> 
        <div class="flex items-start space-x-2">
            <img class="bot-icon w-10 h-10 rounded-full border border-gray-200 bg-white shadow-sm z-10" alt="icon">
            <div class="bubble bubble-left bg-white p-3 shadow-sm max-w-[80%]">
                <p class="text-sm leading-relaxed">
                    èª¿ã¹ãŸã„ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’å…¥åŠ›ã—ã¦ã­ã€‚<br>aikoã®æ›²ã‹ã‚‰æ¢ã—ã¦ãã‚‹ã‚ˆï¼
                </p>
            </div>
        </div>
    </main>

    <!-- 2. æ¥½æ›²DBãƒãƒ£ãƒƒãƒˆ -->
    <main id="chat-container-title" class="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar pb-64 hidden"> 
        <div class="flex items-start space-x-2">
            <img class="bot-icon w-10 h-10 rounded-full border border-gray-200 bg-white shadow-sm z-10" alt="icon">
            <div class="bubble bubble-left bg-white p-3 shadow-sm max-w-[80%]">
                <p class="text-sm leading-relaxed">
                    æ›²åã‚„ã‚¢ãƒ«ãƒãƒ åã‚’å…¥åŠ›ã—ã¦ã­ã€‚<br>ãƒªãƒªãƒ¼ã‚¹æƒ…å ±ã‚„åéŒ²æ›²é †ã‚’æ•™ãˆã‚‹ã‚ˆğŸ’¿
                </p>
            </div>
        </div>
    </main>

    <!-- 3. ã—ã‚Šã¨ã‚Šãƒãƒ£ãƒƒãƒˆ -->
    <main id="chat-container-shiritori" class="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar pb-64 hidden"> 
        <div class="flex items-start space-x-2">
            <img class="bot-icon w-10 h-10 rounded-full border border-gray-200 bg-white shadow-sm z-10" alt="icon">
            <div class="bubble bubble-left bg-white p-3 shadow-sm max-w-[80%]">
                <p class="text-sm leading-relaxed">
                    ã•ãã€ã—ã‚Šã¨ã‚Šã®æ™‚é–“ã ã€‚<br>
                    æœ€åˆã®æ›²åã‚’å…¥åŠ›ã—ã¦ã­ã€‚<br>
                    ï¼ˆä¾‹ï¼šèŠ±ç«ï¼‰
                </p>
            </div>
        </div>
    </main>

    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
    <footer class="bg-white border-t border-gray-100 fixed bottom-0 w-full safe-pb z-30 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] flex flex-col" style="padding-bottom: calc(env(safe-area-inset-bottom));">
        
        <!-- ãƒ©ãƒ³ãƒ€ãƒ æ­Œè©ã‚¨ãƒªã‚¢ -->
        <div id="random-lyric-container" class="bg-orange-50/50 border-b border-orange-100 py-1 px-4 transition-all duration-300 opacity-0 h-0 overflow-hidden">
             <div id="random-lyric-area" class="text-[10px] text-orange-400 text-center truncate h-4 leading-4"></div>
        </div>

        <!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
        <form id="search-form" class="flex items-center gap-2 px-3 py-3 border-b border-gray-50">
            <div class="flex-1 bg-gray-100 rounded-full flex items-center px-4 py-2.5 transition-colors focus-within:bg-white focus-within:ring-1 focus-within:ring-gray-200 border border-transparent focus-within:border-gray-200">
                <input type="text" id="search-input" 
                    class="flex-1 bg-transparent border-none focus:outline-none text-sm placeholder-gray-400"
                    placeholder="ä¾‹ï¼šç”˜ã„åŒ‚ã„ã«" required autocomplete="off">
            </div>
            
            <button type="submit" 
                class="send-btn-active text-theme p-2.5 rounded-full hover:bg-theme-soft transition flex-shrink-0 shadow-sm border border-transparent hover:border-theme">
                <i data-lucide="send" class="w-5 h-5 fill-current transition-colors duration-300"></i>
            </button>
        </form>

        <!-- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ (IDã‚’ä»˜ä¸) -->
        <div id="footer-tab-area" class="flex w-full bg-white relative">
            <button id="tab-lyrics" data-tab="lyrics" onclick="switchTab('lyrics')" class="tab-btn active flex-1 py-3 text-center transition-all flex flex-col items-center justify-center gap-1">
                <i data-lucide="music" class="w-5 h-5 mb-0.5"></i>
                <span class="text-base leading-none">æ­Œè©</span>
            </button>
            <div class="w-[1px] bg-gray-100 my-2"></div>
            <button id="tab-title" data-tab="title" onclick="switchTab('title')" class="tab-btn flex-1 py-3 text-center transition-all flex flex-col items-center justify-center gap-1">
                <i data-lucide="disc" class="w-5 h-5 mb-0.5"></i>
                <span class="text-base leading-none">æ¥½æ›²</span>
            </button>
        </div>
    </footer>

    <div id="toast" class="fixed top-24 left-1/2 transform -translate-x-1/2 bg-gray-800/80 backdrop-blur text-white text-xs py-2 px-4 rounded-full opacity-0 transition-opacity duration-300 pointer-events-none z-50 shadow-lg">
        ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼
    </div>

    <div id="readme-modal" class="fixed inset-0 z-50 hidden" aria-hidden="true">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onclick="toggleModal(false)"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white w-[90%] max-w-sm rounded-2xl shadow-xl p-6 transition-all scale-100">
            <div class="flex justify-between items-start mb-4">
                <h2 class="text-lg font-bold text-theme flex items-center gap-2">
                    <i data-lucide="info" class="w-5 h-5"></i> ä½¿ã„æ–¹
                </h2>
                <button onclick="toggleModal(false)" class="text-gray-400 hover:text-gray-600 p-1">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="space-y-4 text-sm text-gray-700 leading-relaxed overflow-y-auto max-h-[60vh]">
                <section>
                    <h3 class="font-bold text-gray-800 mb-1">ğŸŸ§ æ­Œè©ãƒ¢ãƒ¼ãƒ‰</h3>
                    <p class="text-xs">æ­Œè©ã‹ã‚‰æ›²ã‚’æ¢ã™ã‚ˆ</p>
                </section>
                <section>
                    <h3 class="font-bold text-sky-600 mb-1">ğŸŸ¦ æ¥½æ›²ãƒ¢ãƒ¼ãƒ‰</h3>
                    <p class="text-xs">æ›²åã‹ã‚‰è©³ç´°æƒ…å ±ã‚’æ¢ã™ã‚ˆ</p>
                </section>
                <section>
                    <h3 class="font-bold text-pink-500 mb-1">â¬› è£ãƒ¢ãƒ¼ãƒ‰...ï¼Ÿ</h3>
                    <p class="text-xs">ã‚¿ã‚¤ãƒˆãƒ«ã€Œaikoã®æ­Œè©ã¨ã‹èª¿ã¹ã‚‹ã‚„ã¤ã€ã‚’ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨...<br>â€»æˆ»ã‚‹æ™‚ã‚‚ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã—ã¦ã­ã€‚</p>
                </section>
                <section class="text-center pt-2">
                    <p class="text-xs text-gray-400">aikoã®æ­Œè©ã¨ã‹èª¿ã¹ã‚‹ã‚„ã¤ v0.3.6</p>
                </section>
            </div>
            <button onclick="toggleModal(false)" class="mt-6 w-full bg-gray-500 text-white font-bold py-3 rounded-xl shadow-md hover:bg-gray-600 transition active:scale-95">
                é–‰ã˜ã‚‹
            </button>
        </div>
    </div>

    <script>
        const APP_VERSION = 'v0.3.6';
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycby49eACsPr_lGblpklhK13gt4TroRwNyKwnQcKQ3GPhACQ8zV96YZ9_CDXfFn5wOj85/exec"; 
        const TWITTER_ID = "noki_dochibi";
        const ICON_URL = `https://unavatar.io/twitter/${TWITTER_ID}?v=${APP_VERSION}`;

        let currentMode = 'lyrics'; 
        let lastMode = 'lyrics'; 
        let isDarkMode = false; 

        const LOADING_MESSAGES = {
            lyrics: ["aikoã‹ã‚‰ã®telepathyã‚’å—ä¿¡ä¸­...", "ãã‚“ãªã“ã¨ã‚ˆã‚Šãƒ‘ãƒ¼ãƒ†ã‚£æŠœã‘å‡ºã•ãªã„ï¼Ÿ"],
            title: ["ã‚ãƒ¼ã€ãã®æ›²ãªã‚‰ç¢ºã‹...", "ã†ã‚“ã†ã‚“ï¼ä¿ºã‚‚ãã‚Œå¥½ãã ã‚ˆï¼å¾…ã£ã¦ã¦..."],
            shiritori: ["ä¿ºã«å‹è² ã‚’ä»•æ›ã‘ã‚‹ã¨ã¯ã„ã„åº¦èƒ¸ã ã€‚", "ãªã‚‹ã»ã©ã€ãã†æ¥ãŸã‹..."]
        };

        const dom = {
            body: document.getElementById('app-body'),
            containerLyrics: document.getElementById('chat-container-lyrics'),
            containerTitle: document.getElementById('chat-container-title'),
            containerShiritori: document.getElementById('chat-container-shiritori'),
            searchForm: document.getElementById('search-form'),
            searchInput: document.getElementById('search-input'),
            randomContainer: document.getElementById('random-lyric-container'),
            randomArea: document.getElementById('random-lyric-area'),
            toast: document.getElementById('toast'),
            version: document.getElementById('version-display'),
            modal: document.getElementById('readme-modal'),
            tabBtns: document.querySelectorAll('.tab-btn'),
            botIcons: document.querySelectorAll('.bot-icon')
        };

        window.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            if (dom.version) dom.version.textContent = APP_VERSION;
            dom.botIcons.forEach(img => img.src = ICON_URL);
            new Image().src = ICON_URL;
            dom.randomArea.textContent = "";
            dom.randomContainer.classList.add('opacity-0', 'h-0', 'overflow-hidden');
            dom.randomContainer.style.height = '0';
        });

        // â˜…éš ã—ã‚³ãƒãƒ³ãƒ‰: è£ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ (Toggle)
        window.activateSecretMode = function() {
            if (currentMode === 'shiritori') {
                // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã‚‹
                isDarkMode = false;
                dom.body.classList.remove('dark-mode');
                switchTab(lastMode);
                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‰Šé™¤
            } else {
                // è£ãƒ¢ãƒ¼ãƒ‰ã¸
                lastMode = currentMode;
                isDarkMode = true;
                dom.body.classList.add('dark-mode');
                switchTab('shiritori');
                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‰Šé™¤
            }
        };

        window.switchTab = function(mode) {
            if (currentMode === mode) return;
            currentMode = mode;
            
            dom.tabBtns.forEach(btn => {
                if (btn.dataset.tab === mode) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            dom.containerLyrics.classList.add('hidden');
            dom.containerTitle.classList.add('hidden');
            dom.containerShiritori.classList.add('hidden');
            dom.randomContainer.classList.add('opacity-0', 'h-0', 'overflow-hidden');
            dom.randomContainer.style.height = '0';

            if (mode === 'lyrics') {
                dom.body.classList.replace('theme-title', 'theme-lyrics');
                dom.body.classList.replace('theme-shiritori', 'theme-lyrics');
                dom.body.classList.replace('bg-sky-50', 'bg-orange-50');
                dom.body.classList.replace('bg-pink-50', 'bg-orange-50');
                
                dom.containerLyrics.classList.remove('hidden');
                
                if (dom.randomArea.textContent.trim() !== "") {
                    dom.randomContainer.style.height = 'auto';
                    dom.randomContainer.classList.remove('opacity-0', 'h-0', 'overflow-hidden');
                    dom.randomContainer.classList.add('opacity-100');
                }
                dom.searchInput.placeholder = "ä¾‹ï¼šç”˜ã„åŒ‚ã„ã«";
                document.documentElement.style.setProperty('--bubble-color', '#f97316');

            } else if (mode === 'title') {
                dom.body.classList.replace('theme-lyrics', 'theme-title');
                dom.body.classList.replace('theme-shiritori', 'theme-title');
                dom.body.classList.replace('bg-orange-50', 'bg-sky-50');
                dom.body.classList.replace('bg-pink-50', 'bg-sky-50');
                
                dom.containerTitle.classList.remove('hidden');
                
                dom.searchInput.placeholder = "ä¾‹ï¼šãƒãƒ‹ãƒ¼ãƒ†ãƒ¼ãƒ«";
                document.documentElement.style.setProperty('--bubble-color', '#0ea5e9');

            } else if (mode === 'shiritori') {
                dom.body.classList.replace('theme-lyrics', 'theme-shiritori');
                dom.body.classList.replace('theme-title', 'theme-shiritori');
                dom.body.classList.replace('bg-orange-50', 'bg-pink-50');
                dom.body.classList.replace('bg-sky-50', 'bg-pink-50');
                
                dom.containerShiritori.classList.remove('hidden');
                
                dom.searchInput.placeholder = "æ›²åã‚’ç•¥ã•ãšå…¥åŠ›ã—ã¦ã­";
                document.documentElement.style.setProperty('--bubble-color', '#ec4899');
            }
        };

        function getActiveContainer() {
            if (currentMode === 'lyrics') return dom.containerLyrics;
            if (currentMode === 'title') return dom.containerTitle;
            return dom.containerShiritori;
        }

        window.sendShiritoriAnswer = function(text) {
            dom.searchInput.value = text;
            dom.searchForm.dispatchEvent(new Event('submit'));
        };

        dom.searchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const query = dom.searchInput.value.trim();
            if (!query) return;

            addMessage(query, 'user');
            dom.searchInput.value = '';
            const loadingId = addLoading();

            try {
                const response = await fetch(`${GAS_API_URL}?q=${encodeURIComponent(query)}&mode=${currentMode}`);
                const data = await response.json();
                removeLoading(loadingId);

                if (data.status === 'success') {
                    if (currentMode === 'lyrics') handleLyricsResults(data);
                    else if (currentMode === 'title') handleTitleResults(data);
                    else handleShiritoriResults(data);
                } else {
                    addMessage("ã”ã‚ã‚“ã­ã€ã†ã¾ãæ¢ã›ãªã‹ã£ãŸã¿ãŸã„... (ã‚¨ãƒ©ãƒ¼)", 'bot');
                }
            } catch (error) {
                removeLoading(loadingId);
                console.error(error);
                addMessage("é€šä¿¡å¤±æ•—ï¼ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ã¿ã¦ï¼", 'bot');
            }
        });

        // ã—ã‚Šã¨ã‚Šçµæœè¡¨ç¤º
        function handleShiritoriResults(data) {
            // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼åˆ¤å®š (è² ã‘ or å‹ã¡/å€™è£œãªã—)
            if (data.game_over || (data.candidates && data.candidates.length === 0)) {
                let contentHtml = `<div class="flex flex-col gap-2"><p>${data.message}</p>`;
                
                // å‹ã¡ï¼ˆå€™è£œåˆ‡ã‚Œï¼‰ã®å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                if (!data.game_over && data.candidates.length === 0) {
                     contentHtml += `<p class="text-xs text-gray-400 mt-1">ï¼ˆç¶šãæ›²ãŒãªã„ã¿ãŸã„ï¼ã‚ãªãŸã®å‹ã¡ ğŸ˜ ï¼‰</p>`;
                }

                // ãƒœã‚¿ãƒ³è¡¨ç¤º
                contentHtml += `
                    <div class="flex gap-2 mt-3">
                        <button onclick="restartShiritori()" class="flex-1 bg-pink-500 text-white border border-pink-600 px-3 py-2 rounded-lg text-xs font-bold shadow-sm hover:bg-pink-600 active:scale-95 transition">
                            ã‚‚ã†ä¸€åº¦éŠã¶
                        </button>
                        <button onclick="exitShiritori()" class="flex-1 bg-gray-700 text-white border border-gray-600 px-3 py-2 rounded-lg text-xs font-bold shadow-sm hover:bg-gray-600 active:scale-95 transition">
                            ãŠã—ã¾ã„ã«ã™ã‚‹
                        </button>
                    </div>
                `;
                contentHtml += `</div>`;
                addMessage(contentHtml, 'bot');
                return;
            }

            // ç¶™ç¶šä¸­
            if (!data.found) {
                addMessage(data.message, 'bot');
                return;
            }

            let contentHtml = `<div class="flex flex-col gap-2"><p>${data.message}</p>`;
            if (data.candidates && data.candidates.length > 0) {
                contentHtml += `<div class="flex flex-wrap gap-2 mt-2">`;
                data.candidates.forEach(cand => {
                    contentHtml += `<button onclick="sendShiritoriAnswer('${cand.title}')" class="bg-white border border-pink-200 text-pink-600 px-3 py-1.5 rounded-full text-xs font-bold shadow-sm hover:bg-pink-50 active:scale-95 transition">${cand.title}</button>`;
                });
                contentHtml += `</div>`;
            }
            contentHtml += `</div>`;
            addMessage(contentHtml, 'bot');
        }

        window.restartShiritori = function() {
            dom.containerShiritori.innerHTML = `
                <div class="flex items-start space-x-2">
                    <img class="bot-icon w-10 h-10 rounded-full border border-gray-200 bg-white shadow-sm z-10" src="${ICON_URL}">
                    <div class="bubble bubble-left bg-white px-4 py-3 shadow-sm max-w-[80%] text-sm break-words leading-relaxed">
                        <p>ã—ã‚Šã¨ã‚Šãƒªã‚»ãƒƒãƒˆï¼<br>æœ€åˆã®æ›²åã‚’å…¥åŠ›ã—ã¦ã­ã€‚<br>ï¼ˆä¾‹ï¼šèŠ±ç«ï¼‰</p>
                    </div>
                </div>
            `;
        };

        window.exitShiritori = function() {
            activateSecretMode(); // ãƒˆã‚°ãƒ«ã§æˆ»ã‚‹
        };

        // å…±é€šé–¢æ•°ç¾¤
        function handleLyricsResults(data) {
            if (data.random_message) {
                dom.randomArea.textContent = 'ãƒ©ãƒ³ãƒ€ãƒ è¡¨ç¤ºï¼š' + data.random_message;
                dom.randomContainer.style.height = 'auto';
                dom.randomContainer.classList.remove('opacity-0', 'h-0', 'overflow-hidden');
                dom.randomContainer.classList.add('opacity-100');
            }
            if (!data.results || data.results.length === 0) {
                addMessage(`ã€Œ${data.query}ã€ã¯è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸã‚ˆã€‚æ­Œè©ã‚«ãƒ¼ãƒ‰ã¨åŒã˜è¡¨è¨˜ã«ã—ã¦ã¿ã¦ï¼`, 'bot');
                return;
            }

            let contentHtml = '<div class="flex flex-col animate-fade-in">';
            
            // â˜… ã‚‚ã—ã‹ã—ã¦æ¤œç´¢ã®ãƒ’ãƒƒãƒˆè¡¨ç¤º
            if (data.fuzzy_type) {
                contentHtml += `<div class="bg-orange-100/50 border border-orange-200 rounded-lg p-2.5 mb-3 text-xs text-orange-700">
                    ã€Œ<span class="font-bold">${data.query}</span>ã€ã¯è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸã‘ã©ã€<br>
                    ã€Œ<span class="font-bold text-orange-600">${data.actual_query}</span>ã€ã§è¦‹ã¤ã‹ã£ãŸã‚ˆï¼ (${data.fuzzy_type})
                </div>`;
            }

            // ãƒã‚¤ãƒ©ã‚¤ãƒˆã•ã›ã‚‹å¯¾è±¡ã®ãƒ¯ãƒ¼ãƒ‰ï¼ˆfuzzyã®å ´åˆã¯ãã¡ã‚‰ã‚’ä½¿ã†ï¼‰
            const highlightWord = data.fuzzy_type ? data.actual_query : data.query;

            data.results.forEach((item, index) => {
                const borderClass = index < data.results.length - 1 ? 'border-b border-dashed border-theme' : '';
                const highlightedPhrase = item.phrase.replace(new RegExp(`(${highlightWord})`, 'gi'), '<span class="highlight-text">$1</span>');
                contentHtml += `<div onclick="copyToClipboard('${item.display_text.replace(/'/g, "\\'")}')" class="${borderClass} py-3 cursor-pointer hover:bg-theme-soft transition relative group select-none"><p class="text-sm font-medium text-gray-700 leading-relaxed pl-1">${highlightedPhrase} <span class="text-xs text-gray-400 ml-1">ï¼ˆ${item.title}ï¼‰</span></p></div>`;
            });
            contentHtml += '</div>';
            
            const allText = data.results.map(item => item.display_text).join('\\n').replace(/'/g, "\\'");
            contentHtml += `<div class="animate-fade-in mt-3 pt-2 border-t border-dashed border-theme"><div class="flex flex-wrap items-center justify-between gap-2"><p class="text-[10px] text-gray-400">è¨ˆ${data.results.length}ç®‡æ‰€ã§è¦‹ã¤ã‹ã£ãŸã‚ˆâ™ª</p><button onclick="copyToClipboard('${allText}')" class="text-[10px] text-theme hover:text-opacity-80 flex items-center gap-1 bg-theme-soft px-3 py-1.5 rounded-full transition shadow-sm border border-theme"><i data-lucide="copy" class="w-3 h-3"></i> ã¾ã¨ã‚ã¦ã‚³ãƒ”ãƒ¼</button></div></div>`;
            contentHtml += `<div class="flex justify-center mt-3 pt-2"><button onclick="this.closest('.message-row').scrollIntoView({behavior:'smooth', block:'start'})" class="text-[10px] text-orange-300 hover:text-orange-500 flex items-center gap-1 transition px-2 py-1 rounded-full hover:bg-white"><i data-lucide="arrow-up" class="w-3 h-3"></i> ã“ã®å›ç­”ã®ãƒˆãƒƒãƒ—ã¸ç§»å‹•</button></div>`;
            addMessage(contentHtml, 'bot', true);
            lucide.createIcons();
        }

        function handleTitleResults(data) {
             if ((!data.songs || data.songs.length === 0) && (!data.albums || data.albums.length === 0)) {
                addMessage(`ã€Œ${data.query}ã€ã¯è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸã‚ˆã€‚æ­£å¼åç§°ï¼ˆã¾ãŸã¯ãã®ä¸€éƒ¨ï¼‰ã‚’æ•™ãˆã¦ã­ï¼`, 'bot');
                return;
            }
            let contentHtml = '<div class="flex flex-col gap-6 animate-fade-in">';
            if (data.songs && data.songs.length > 0) {
                let songSection = '<div class="flex flex-col gap-4">';
                if (data.albums && data.albums.length > 0) songSection += '<div class="text-xs font-bold text-sky-500 border-b border-sky-100 pb-1">ğŸµ æ›²ã®æ¤œç´¢çµæœ</div>';
                data.songs.forEach((song, idx) => {
                    const hasDivider = idx > 0 ? 'border-t border-sky-100 pt-4' : '';
                    const ageText = song.age_at_release ? `ãƒªãƒªãƒ¼ã‚¹æ™‚ã®aikoã¯<span class="font-bold text-sky-600">${song.age_at_release}æ­³</span>ã ã‚ˆã€‚` : '';
                    const songLink = song.link_url ? `<a href="${song.link_url}" target="_blank" class="text-sky-600 underline font-bold hover:text-sky-400">${song.title}</a>` : `<span class="font-bold text-gray-800">${song.title}</span>`;
                    songSection += `<div class="${hasDivider}"><div class="mb-2 text-base">${songLink} <span class="text-xs text-gray-400">(${song.reading || ''})</span></div><div class="text-sm text-gray-700 space-y-2 leading-relaxed bg-sky-50/50 p-3 rounded-lg border border-sky-100">${song.single_info ? `<p>ğŸ’¿ ${song.single_info}</p>` : ''}${song.album_info ? `<p>ğŸ’¿ ${song.album_info}</p>` : '<p class="text-gray-400">ğŸ’¿ ã‚¢ãƒ«ãƒãƒ ã«ã¯æœªåéŒ²ã ã‚ˆã€‚</p>'}<div class="pt-2 border-t border-sky-100 text-xs text-gray-600"><p>ğŸ¼ ç·¨æ›²ï¼š${song.arranger || 'ä¸æ˜'}</p><p>â± å†ç”Ÿæ™‚é–“ï¼š${song.duration || 'ä¸æ˜'}</p><p>ğŸ¥ BPMï¼š${song.bpm || 'ç¢ºèªä¸­'}</p></div><p class="pt-1 text-xs text-sky-700 font-medium">${ageText}</p></div></div>`;
                });
                songSection += '</div>';
                contentHtml += songSection;
            }
            if (data.albums && data.albums.length > 0) {
                let albumSection = '<div class="flex flex-col gap-4">';
                if (data.songs && data.songs.length > 0) albumSection += '<div class="text-xs font-bold text-sky-500 border-b border-sky-100 pb-1">ğŸ’¿ åéŒ²ãƒ‡ã‚£ã‚¹ã‚¯æƒ…å ±</div>';
                data.albums.forEach((disk) => {
                    const songList = disk.songs.map((s, i) => `<li class="py-1 border-b border-sky-50 last:border-0 flex gap-2"><span class="text-sky-400 w-6 text-right font-mono text-xs pt-0.5">${s.order}.</span><span>${s.title}</span></li>`).join('');
                    albumSection += `<div class="bg-sky-50/50 rounded-xl p-4 border border-sky-100"><h3 class="font-bold text-sky-700 mb-1">ğŸ’¿ ${disk.disk_name}</h3><p class="text-xs text-gray-500 mb-3">${disk.release_date} ç™ºå£²</p><ul class="text-sm text-gray-700 list-none">${songList}</ul></div>`;
                });
                albumSection += '</div>';
                contentHtml += albumSection;
            }
            contentHtml += '</div>';
            contentHtml += `<div class="flex justify-center mt-3 pt-2"><button onclick="this.closest('.message-row').scrollIntoView({behavior:'smooth', block:'start'})" class="text-[10px] text-sky-300 hover:text-sky-500 flex items-center gap-1 transition px-2 py-1 rounded-full hover:bg-white"><i data-lucide="arrow-up" class="w-3 h-3"></i> ã“ã®å›ç­”ã®ãƒˆãƒƒãƒ—ã¸ç§»å‹•</button></div>`;
            addMessage(contentHtml, 'bot', true);
            lucide.createIcons();
        }

        function addMessage(htmlOrText, type, shouldScroll = true) {
            const div = document.createElement('div');
            div.className = `flex items-start space-x-2 message-row ${type === 'user' ? 'justify-end' : ''}`;
            const bubbleClass = type === 'user' ? 'bubble bubble-right text-white' : 'bubble bubble-left bg-white text-gray-800';
            
            let userBgClass = 'bg-gray-500';
            if (currentMode === 'lyrics') userBgClass = 'bg-orange-500';
            else if (currentMode === 'title') userBgClass = 'bg-sky-500';
            else if (currentMode === 'shiritori') userBgClass = 'bg-pink-500';

            const finalBubbleClass = type === 'user' ? `${bubbleClass} ${userBgClass}` : bubbleClass;
            const iconHtml = type === 'bot' ? `<img src="${ICON_URL}" class="bot-icon w-10 h-10 rounded-full border border-gray-200 bg-white flex-shrink-0 shadow-sm z-10">` : '';
            div.innerHTML = type === 'bot' ? iconHtml + `<div class="${finalBubbleClass} px-4 py-3 shadow-sm max-w-[85%] text-sm break-words leading-relaxed">${htmlOrText}</div>` : `<div class="${finalBubbleClass} px-4 py-3 shadow-sm max-w-[85%] text-sm break-words leading-relaxed">${htmlOrText}</div>`;
            getActiveContainer().appendChild(div);
            if (shouldScroll) scrollToBottom();
        }

        function addLoading() {
            const id = 'loading-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = "flex items-start space-x-2";
            const msgs = LOADING_MESSAGES[currentMode];
            const randomMsg = msgs[Math.floor(Math.random() * msgs.length)];
            div.innerHTML = `<img src="${ICON_URL}" class="bot-icon w-10 h-10 rounded-full border border-gray-200 bg-white flex-shrink-0 shadow-sm z-10"><div class="bubble bubble-left bg-white px-4 py-3 shadow-sm"><p class="text-sm text-gray-500 pulse-text">${randomMsg}</p></div>`;
            getActiveContainer().appendChild(div);
            scrollToBottom();
            return id;
        }

        function removeLoading(id) { const el = document.getElementById(id); if (el) el.remove(); }
        function scrollToBottom() { const container = getActiveContainer(); container.scrollTop = container.scrollHeight; }
        
        function copyToClipboard(text) {
            const cleanText = text.replace(/<br>/g, '\n');
            if (navigator.clipboard) { navigator.clipboard.writeText(cleanText).then(showToast); } 
            else { const ta = document.createElement('textarea'); ta.value = cleanText; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); showToast(); }
        }
        function showToast() { dom.toast.classList.remove('opacity-0'); setTimeout(() => dom.toast.classList.add('opacity-0'), 2000); }
        function toggleModal(show) {
            if (show) { dom.modal.classList.remove('hidden'); setTimeout(() => { dom.modal.querySelector('div:last-child').classList.remove('modal-enter'); dom.modal.querySelector('div:last-child').classList.add('modal-enter-active'); }, 10); } 
            else { dom.modal.classList.add('hidden'); }
        }
    </script>
</body>
</html>



