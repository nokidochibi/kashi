<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <!-- 
      viewportè¨­å®š: 
      ãƒ”ãƒ³ãƒã‚¤ãƒ³ãƒ»ã‚¢ã‚¦ãƒˆç„¡åŠ¹åŒ– (user-scalable=no)
    -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>aikotoba - aikoæ­Œè©æ¤œç´¢</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; }
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼éè¡¨ç¤º */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* ãƒœã‚¿ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .send-btn-active:active { transform: scale(0.9); }

        /* iPhone Safe Areaå¯¾ç­– */
        .safe-pb {
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆç‚¹æ»…ï¼‰ */
        .pulse-text {
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }

        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã®èª¿æ•´ã‚¯ãƒ©ã‚¹ */
        .message-row {
            scroll-margin-top: 5rem;
        }

        /* ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆä¸€æ‹¬è¡¨ç¤ºç”¨ï¼‰ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        /* ãƒã‚¤ãƒ©ã‚¤ãƒˆç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .highlight-text {
            color: #ea580c; /* orange-600 */
            font-weight: bold;
            background-color: #fff7ed; /* orange-50 */
            padding: 0 2px;
            border-radius: 2px;
        }

        /* LINEé¢¨å¹ãå‡ºã—ãƒ‡ã‚¶ã‚¤ãƒ³ (ã—ã£ã½ä»˜ã) */
        .bubble {
            position: relative;
            border-radius: 1.2rem; /* å…¨ä½“ã‚’ä¸¸ã */
        }
        
        /* User (å³å´) ã®ã—ã£ã½ */
        .bubble-right::before {
            content: "";
            position: absolute;
            top: 10px;    /* ä¸Šã‹ã‚‰ã®ä½ç½® */
            right: -8px;  /* å³ã«çªãå‡ºã™ */
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 6px 0 6px 10px; /* ä¸‰è§’å½¢ã‚’æç”» */
            border-color: transparent transparent transparent #f97316; /* orange-500ã¨åŒè‰² */
        }

        /* Bot (å·¦å´) ã®ã—ã£ã½ */
        .bubble-left::before {
            content: "";
            position: absolute;
            top: 10px;
            left: -8px;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 6px 10px 6px 0;
            border-color: transparent #ffffff transparent transparent; /* bg-whiteã¨åŒè‰² */
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .modal-enter {
            opacity: 0;
            transform: scale(0.95);
        }
        .modal-enter-active {
            opacity: 1;
            transform: scale(1);
            transition: opacity 0.2s ease-out, transform 0.2s ease-out;
        }
        .modal-exit {
            opacity: 1;
            transform: scale(1);
        }
        .modal-exit-active {
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 0.2s ease-in, transform 0.2s ease-in;
        }
    </style>
</head>
<body class="bg-orange-50 text-gray-800 h-screen flex flex-col">

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="bg-white/90 backdrop-blur-sm p-3 shadow-sm flex items-center justify-center sticky top-0 z-10 border-b border-orange-100 relative">
        <h1 class="text-lg font-bold text-orange-600 tracking-wider flex items-baseline">
            aikotoba
            <!-- ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¡¨ç¤º -->
            <span id="version-display" class="ml-2 text-[10px] text-gray-400 font-normal opacity-50"></span>
        </h1>
        
        <!-- ãƒ˜ãƒ«ãƒ—ãƒœã‚¿ãƒ³ (Readme) -->
        <button onclick="toggleModal(true)" class="absolute right-4 text-orange-400 hover:text-orange-600 transition p-1 rounded-full hover:bg-orange-50">
            <i data-lucide="help-circle" class="w-6 h-6"></i>
        </button>
    </header>

    <!-- ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ -->
    <main id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar pb-40"> 
        
        <!-- hokiã•ã‚“ (åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸) -->
        <div class="flex items-start space-x-2">
            <img id="bot-icon-initial" src="" alt="hoki" class="w-10 h-10 rounded-full border border-gray-200 bg-white shadow-sm z-10">
            <!-- Botã®å¹ãå‡ºã—ã‚¯ãƒ©ã‚¹é©ç”¨ -->
            <div class="bubble bubble-left bg-white p-3 shadow-sm max-w-[80%]">
                <p class="text-sm leading-relaxed">å¥½ããªãƒ•ãƒ¬ãƒ¼ã‚ºã‚’å…¥åŠ›ã—ã¦ã­ã€‚<br>aikoã®æ›²ã‹ã‚‰æ¢ã—ã¦ãã‚‹ã‚ˆï¼</p>
            </div>
        </div>

    </main>

    <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ -->
    <footer class="bg-white px-3 py-2 border-t border-gray-100 fixed bottom-0 w-full safe-pb" style="padding-bottom: calc(env(safe-area-inset-bottom) + 20px);">
        <!-- ãƒ©ãƒ³ãƒ€ãƒ æ­Œè©è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="random-lyric-area" class="text-[10px] text-gray-400 text-center mb-1 h-4 truncate"></div>

        <form id="search-form" class="flex items-center gap-2">
            <div class="flex-1 bg-gray-100 rounded-full flex items-center px-4 py-2">
                <input type="text" id="search-input" 
                    class="flex-1 bg-transparent border-none focus:outline-none text-sm placeholder-gray-400"
                    placeholder="ä¾‹ï¼šç”˜ã„åŒ‚ã„ã«" required autocomplete="off">
            </div>
            
            <button type="submit" 
                class="send-btn-active text-orange-500 p-2 rounded-full hover:bg-orange-50 transition flex-shrink-0">
                <i data-lucide="send" class="w-6 h-6 fill-current"></i>
            </button>
        </form>
    </footer>

    <!-- ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ -->
    <div id="toast" class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-gray-800/80 backdrop-blur text-white text-xs py-2 px-4 rounded-full opacity-0 transition-opacity duration-300 pointer-events-none z-50 shadow-lg">
        ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼
    </div>

    <!-- Readme ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="readme-modal" class="fixed inset-0 z-50 hidden" aria-hidden="true">
        <!-- èƒŒæ™¯ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onclick="toggleModal(false)"></div>
        
        <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white w-[90%] max-w-sm rounded-2xl shadow-xl p-6 transition-all scale-100">
            <div class="flex justify-between items-start mb-4">
                <h2 class="text-lg font-bold text-orange-600 flex items-center gap-2">
                    <i data-lucide="info" class="w-5 h-5"></i> ä½¿ã„æ–¹ã¨ãƒ’ãƒ³ãƒˆ
                </h2>
                <button onclick="toggleModal(false)" class="text-gray-400 hover:text-gray-600 p-1">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="space-y-4 text-sm text-gray-700 leading-relaxed overflow-y-auto max-h-[60vh]">
                <section>
                    <h3 class="font-bold text-gray-800 mb-1">ğŸ” æ¤œç´¢ã«ã¤ã„ã¦</h3>
                    <p>å¥½ããªãƒ•ãƒ¬ãƒ¼ã‚ºã‚’å…¥åŠ›ã—ã¦é€ä¿¡ã—ã¦ãã ã•ã„ã€‚aikoã®å…¨æ¥½æ›²ã‹ã‚‰ã€ãã®è¨€è‘‰ãŒå«ã¾ã‚Œã‚‹ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’æ¢ã—å‡ºã—ã¾ã™ã€‚</p>
                </section>

                <section class="bg-orange-50 p-3 rounded-xl border border-orange-100">
                    <h3 class="font-bold text-orange-700 mb-1 text-xs">ğŸ’¡ è¦‹ã¤ã‹ã‚‰ãªã„ã¨ãã¯ï¼Ÿ</h3>
                    <p class="text-xs">
                        ãã®ã¾ã¾ã®è¨€è‘‰ã§è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€è‡ªå‹•ã§<b>ã€Œã²ã‚‰ãŒãªã€</b>ã‚„<b>ã€Œã‚«ã‚¿ã‚«ãƒŠã€</b>ã«å¤‰æ›ã—ã¦æ¢ã—ç›´ã—ã¾ã™ã€‚<br>
                        <span class="text-gray-500 block mt-1">ï¼ˆä¾‹ï¼šã€Œã‚µã‚¯ãƒ©ã€ã¨å…¥åŠ› â†’ ã€Œã•ãã‚‰ã€ã‚‚æ¢ã—ã¾ã™ï¼‰</span>
                    </p>
                    <p class="text-xs mt-2 text-orange-800">
                        â€» ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã®å¤§æ–‡å­—ãƒ»å°æ–‡å­—ã€å…¨è§’ãƒ»åŠè§’ã®é•ã„ã‚‚è‡ªå‹•ã§èª¿æ•´ã—ã¦æ¢ã—ã¾ã™ã€‚
                    </p>
                </section>

                <section class="bg-gray-50 p-3 rounded-xl border border-gray-200">
                    <h3 class="font-bold text-gray-700 mb-1 text-xs">âš ï¸ ã”æ³¨æ„ãƒ»ä»•æ§˜</h3>
                    <ul class="list-disc list-inside text-xs space-y-1 text-gray-600">
                        <li>è¦‹ã¤ã‹ã‚‰ãªã„ã¨ãã¯ã€æ­Œè©ã‚«ãƒ¼ãƒ‰é€šã‚Šã®è¡¨è¨˜ï¼ˆæ¼¢å­—ãƒ»ã²ã‚‰ãŒãªï¼‰ã§å…¥åŠ›ã—ã¦ã¿ã¦ãã ã•ã„ã€‚</li>
                        <li>åŒã˜æ›²ã®ä¸­ã«åŒã˜ãƒ•ãƒ¬ãƒ¼ã‚ºãŒè¤‡æ•°å›ç™»å ´ã™ã‚‹å ´åˆã€ãã®å›æ•°åˆ†è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</li>
                        <li>ã‚¤ãƒ³ãƒ‡ã‚£ãƒ¼ã‚ºãƒ»ã‚·ãƒ³ã‚°ãƒ«ãƒ»ã‚¢ãƒ«ãƒãƒ æ›²ã‚’å«ã¿ã¾ã™ï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³é•ã„ã«ã‚ˆã‚‹é‡è¤‡ã¯é™¤ãã¾ã™ï¼‰ã€‚</li>
                    </ul>
                </section>

                <section class="bg-blue-50 p-3 rounded-xl border border-blue-100">
                    <h3 class="font-bold text-blue-700 mb-1 text-xs">ğŸ”’ å±¥æ­´ã¨ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼</h3>
                    <p class="text-xs text-blue-900">
                        æ¤œç´¢ãƒ­ã‚°ï¼ˆã‚ãªãŸãŒä½•ã‚’æ¢ã—ãŸã‹ï¼‰ã¯ã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚<br>
                        ã¾ãŸã€ã“ã®ç”»é¢ã‚’å†èª­ã¿è¾¼ã¿ï¼ˆãƒªãƒ­ãƒ¼ãƒ‰ï¼‰ã™ã‚‹ã¨ã€ã“ã‚Œã¾ã§ã®ä¼šè©±å±¥æ­´ã¯ã™ã¹ã¦æ¶ˆå»ã•ã‚Œã¾ã™ã€‚
                    </p>
                </section>
                
                <section class="text-center pt-2">
                    <p class="text-xs text-gray-400">aikotoba v0.1.19</p>
                </section>
            </div>
            
            <button onclick="toggleModal(false)" class="mt-6 w-full bg-orange-500 text-white font-bold py-3 rounded-xl shadow-md hover:bg-orange-600 transition active:scale-95">
                é–‰ã˜ã‚‹
            </button>
        </div>
    </div>

    <script>
        // ==========================================
        // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç† (Readme & ãƒ­ã‚¸ãƒƒã‚¯æ›´æ–°)
        // ==========================================
        const APP_VERSION = 'v0.1.19';

        // ==========================================
        // è¨­å®š
        // ==========================================
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycby49eACsPr_lGblpklhK13gt4TroRwNyKwnQcKQ3GPhACQ8zV96YZ9_CDXfFn5wOj85/exec"; 
        const TWITTER_ID = "noki_dochibi";
        const ICON_URL = `https://unavatar.io/twitter/${TWITTER_ID}?v=${APP_VERSION}`;

        // å¾…æ©Ÿä¸­ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒˆ
        const LOADING_MESSAGES = [
            "aikoã®ãƒã‚±ãƒƒãƒˆã®ä¸­ã‚’æ¢ã—ã¦ã„ã¾ã™...",
            "æ­Œè©ã®æ˜Ÿå±‘ã‚’é›†ã‚ã¦ã„ã¾ã™...",
            "ç§˜å¯†ã®ãƒãƒ¼ãƒˆã‚’ã‚ãã£ã¦ã„ã¾ã™...",
            "ãƒ†ãƒˆãƒ©ãƒãƒƒãƒˆã®è£å´ã‚’ç¢ºèªä¸­...",
            "ã‚«ãƒ–ãƒˆãƒ ã‚·ã«èã„ã¦ã„ã¾ã™...",
            "æ·±å¤œ2æ™‚ã®æœ¬éŸ³ã‚’æ¢ã—ã¦ã„ã¾ã™...",
            "èŠ±ç«ã®æ®‹åƒã‚’è¿½ã„ã‹ã‘ã¦ã„ã¾ã™..."
        ];

        const chatContainer = document.getElementById('chat-container');
        const searchForm = document.getElementById('search-form');
        const searchInput = document.getElementById('search-input');
        const randomArea = document.getElementById('random-lyric-area');
        const toast = document.getElementById('toast');
        const versionDisplay = document.getElementById('version-display');
        const readmeModal = document.getElementById('readme-modal');

        // åˆæœŸåŒ–
        window.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            if (versionDisplay) versionDisplay.textContent = APP_VERSION;
            const initialIcon = document.getElementById('bot-icon-initial');
            if (initialIcon) initialIcon.src = ICON_URL;
            const preloadImg = new Image();
            preloadImg.src = ICON_URL;
        });

        // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹é–‰åˆ¶å¾¡
        function toggleModal(show) {
            if (show) {
                readmeModal.classList.remove('hidden');
                setTimeout(() => {
                    readmeModal.querySelector('div:last-child').classList.remove('modal-enter');
                    readmeModal.querySelector('div:last-child').classList.add('modal-enter-active');
                }, 10);
            } else {
                readmeModal.classList.add('hidden');
            }
        }

        // é€ä¿¡å‡¦ç†
        searchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const query = searchInput.value.trim();
            if (!query) return;

            addMessage(query, 'user');
            searchInput.value = '';

            const loadingId = addLoading();

            try {
                const response = await fetch(`${GAS_API_URL}?q=${encodeURIComponent(query)}`);
                const data = await response.json();

                removeLoading(loadingId);

                if (data.status === 'success') {
                    handleSearchResults(data);
                } else {
                    addMessage("ã”ã‚ã‚“ã­ã€ã†ã¾ãæ¢ã›ãªã‹ã£ãŸã¿ãŸã„... (ã‚¨ãƒ©ãƒ¼)", 'bot');
                }

            } catch (error) {
                removeLoading(loadingId);
                console.error(error);
                addMessage("é€šä¿¡ã«å¤±æ•—ã—ã¡ã‚ƒã£ãŸã€‚ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ã¿ã¦ï¼", 'bot');
            }
        });

        // ãƒ†ã‚­ã‚¹ãƒˆãƒã‚¤ãƒ©ã‚¤ãƒˆé–¢æ•°
        function highlightText(text, query) {
            if (!query) return text;
            const safeQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const re = new RegExp(`(${safeQuery})`, 'gi');
            return text.replace(re, '<span class="highlight-text">$1</span>');
        }

        function handleSearchResults(data) {
            if (data.random_message) {
                randomArea.textContent = 'ãƒ©ãƒ³ãƒ€ãƒ è¡¨ç¤ºï¼š' + data.random_message;
            }

            if (data.results.length === 0) {
                addMessage(`ã€Œ${data.query}ã€ã¯è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸã‚ˆ...ğŸ’¦`, 'bot');
                return;
            }

            if (data.is_fuzzy) {
                addMessage(`ã€Œ${data.query}ã€ã¯è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸã‘ã©...<br>ã‚‚ã—ã‹ã—ã¦ã€ã“ã‚Œã‹ãªï¼Ÿ`, 'bot');
            }

            // ==========================================
            // çµæœè¡¨ç¤º (v0.1.18: ã¾ã¨ã‚ã¦ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½è¿½åŠ )
            // ==========================================
            let contentHtml = '<div class="flex flex-col animate-fade-in">';
            
            data.results.forEach((item, index) => {
                const borderClass = index < data.results.length - 1 ? 'border-b border-dashed border-orange-200' : '';
                
                // ãƒã‚¤ãƒ©ã‚¤ãƒˆ: æ­Œè©(phrase)ã®ã¿ãƒã‚¤ãƒ©ã‚¤ãƒˆã—ã€æ›²å(title)ã¯ãã®ã¾ã¾
                const highlightedPhrase = highlightText(item.phrase, data.query);
                
                // è¡¨ç¤ºå½¢å¼ã‚’æ§‹ç¯‰: æ­Œè© + (æ›²å)
                const displayTextHtml = `${highlightedPhrase} <span class="text-xs text-gray-400 ml-1">ï¼ˆ${item.title}ï¼‰</span>`;

                contentHtml += `
                    <div onclick="copyToClipboard('${item.display_text.replace(/'/g, "\\'")}')" 
                         class="${borderClass} py-3 cursor-pointer hover:bg-orange-50/50 transition relative group select-none">
                        <p class="text-sm font-medium text-gray-700 leading-relaxed pl-1">
                            ${displayTextHtml}
                        </p>
                    </div>
                `;
            });
            contentHtml += '</div>';

            // ã¾ã¨ã‚ã¦ã‚³ãƒ”ãƒ¼ç”¨ã®ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ
            const allText = data.results
                .map(item => item.display_text)
                .join('\\n')
                .replace(/'/g, "\\'");
            
            // ãƒ•ãƒƒã‚¿ãƒ¼éƒ¨åˆ†
            contentHtml += `
                <div class="animate-fade-in mt-3 pt-2 border-t border-dashed border-orange-100">
                    <div class="flex flex-wrap items-center justify-between gap-2 mb-2">
                        <p class="text-[10px] text-gray-400">
                            ä¸Šè¨˜${data.results.length}ç®‡æ‰€ã®ãƒ•ãƒ¬ãƒ¼ã‚ºã§è¦‹ã¤ã‹ã£ãŸã‚ˆâ™ª
                        </p>
                        <button onclick="copyToClipboard('${allText}')" 
                                class="text-[10px] text-orange-500 hover:text-orange-700 flex items-center gap-1 bg-orange-50 hover:bg-orange-100 px-3 py-1.5 rounded-full transition shadow-sm border border-orange-100">
                            <i data-lucide="copy" class="w-3 h-3"></i> ã¾ã¨ã‚ã¦ã‚³ãƒ”ãƒ¼
                        </button>
                    </div>

                    <div class="flex justify-center">
                        <button onclick="this.closest('.message-row').scrollIntoView({behavior:'smooth', block:'start'})" 
                                class="text-[10px] text-orange-300 hover:text-orange-500 flex items-center gap-1 transition px-2 py-1 rounded-full hover:bg-gray-50">
                            <i data-lucide="arrow-up" class="w-3 h-3"></i> ã“ã®å›ç­”ã®ãƒˆãƒƒãƒ—ã¸ç§»å‹•
                        </button>
                    </div>
                </div>
            `;

            addMessage(contentHtml, 'bot', true);
            
            lucide.createIcons();
        }

        // addMessageé–¢æ•° (å¹ãå‡ºã—ã‚¯ãƒ©ã‚¹é©ç”¨)
        function addMessage(htmlOrText, type, shouldScroll = true) {
            const div = document.createElement('div');
            // å³æƒãˆãƒ»å·¦æƒãˆã®æŒ‡å®š
            div.className = `flex items-start space-x-2 message-row ${type === 'user' ? 'justify-end' : ''}`;

            // Botã®å ´åˆã®ã¿ã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤º
            const iconHtml = type === 'bot' 
                ? `<img src="${ICON_URL}" class="w-10 h-10 rounded-full border border-gray-200 bg-white flex-shrink-0 shadow-sm z-10">` 
                : '';
            
            // å¹ãå‡ºã—ã‚¯ãƒ©ã‚¹ã®åˆ‡ã‚Šæ›¿ãˆ (bubble-right / bubble-left)
            const bubbleClass = type === 'user' 
                ? 'bubble bubble-right bg-orange-500 text-white' 
                : 'bubble bubble-left bg-white text-gray-800';
            
            const contentHtml = `
                <div class="${bubbleClass} px-4 py-3 shadow-sm max-w-[85%] text-sm break-words leading-relaxed">
                    ${htmlOrText}
                </div>
            `;

            div.innerHTML = type === 'bot' ? iconHtml + contentHtml : contentHtml;
            chatContainer.appendChild(div);
            
            if (shouldScroll) {
                scrollToBottom();
            }
        }

        function addLoading() {
            const id = 'loading-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = "flex items-start space-x-2";
            
            const randomMsg = LOADING_MESSAGES[Math.floor(Math.random() * LOADING_MESSAGES.length)];

            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚‚Botã®å¹ãå‡ºã—ã¨ã—ã¦è¡¨ç¤º
            div.innerHTML = `
                <img src="${ICON_URL}" class="w-10 h-10 rounded-full border border-gray-200 bg-white flex-shrink-0 shadow-sm z-10">
                <div class="bubble bubble-left bg-white px-4 py-3 shadow-sm">
                    <p class="text-sm text-gray-500 pulse-text">
                        ${randomMsg}
                    </p>
                </div>
            `;
            chatContainer.appendChild(div);
            scrollToBottom();
            return id;
        }

        function removeLoading(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function copyToClipboard(text) {
            const cleanText = text.replace(/<br>/g, '\n');
            if (navigator.clipboard) {
                navigator.clipboard.writeText(cleanText).then(() => showToast());
            } else {
                const textarea = document.createElement('textarea');
                textarea.value = cleanText;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showToast();
            }
        }

        function showToast() {
            toast.classList.remove('opacity-0');
            setTimeout(() => {
                toast.classList.add('opacity-0');
            }, 2000);
        }
    </script>
</body>
</html>
