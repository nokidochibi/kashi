/**
 * aikotoba Backend (Google Apps Script)
 * Version: 0.2.0
 * Update: 検索ロジック強化（ひらがな/カタカナ相互変換によるあいまい検索）
 * * * 仕様:
 * 1. GETリクエストを受け付ける。
 * 2. クエリパラメータ `q` で検索語句を受け取る。
 * 3. Step 1: そのまま検索（完全・部分一致）
 * 4. Step 2: ヒット0件なら「ひらがな」に変換して検索
 * 5. Step 3: それでも0件なら「カタカナ」に変換して検索
 * 6. 検索結果とは無関係に、ランダムな歌詞を1行返す。
 */

function doGet(e) {
   // CORS対策
  const output = ContentService.createTextOutput();

   // 検索実行
  const result = processRequest(e);
  const jsonResponse = JSON.stringify(result);

   // JSONとして返却
  output.setMimeType(ContentService.MimeType.JSON);
  output.setContent(jsonResponse);

  return output;
}

function processRequest(e) {
  const query = e.parameter.q;  // 検索ワード
 
  if (!query) {
    return { status: "error", message:  "検索ワードがありません"  };
  }

  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName( "歌詞" );
  if (!sheet) {
    return { status: "error", message:  "「歌詞」シートが見つかりません"  };
  }

   // データの取得 (A列:タイトル, B列:歌詞)
   // ヘッダー行がある前提で、2行目から取得
  const lastRow = sheet.getLastRow();
   // データがない場合のガード
  if (lastRow < 2) {
     return { status: "error", message:  "歌詞データがありません"  };
  }
  const data = sheet.getRange(2, 1, lastRow - 1, 2).getValues();

   // === 検索ロジック (v0.2.0 強化版) ===
 
  let searchResults = [];
  let isFuzzy = false;  // もしかして検索かどうか

   // 1. そのまま検索 (Strict Search)
  searchResults = searchLyrics(data, query);

   // 2. ヒットしなければ、文字種を変えて再検索 (Fuzzy Search)
  if (searchResults.length === 0) {
   
     // パターンA: 入力を「ひらがな」にして検索
     // (例: ユーザーが「サクラ」と入力 -> 「さくら」で歌詞を探す)
    const hiraQuery = toHiragana(query);
    if (hiraQuery !== query) {  // 変換前後で違う場合のみ実行
      const hiraResults = searchLyrics(data, hiraQuery);
      if (hiraResults.length > 0) {
        searchResults = hiraResults;
        isFuzzy = true;  // 「もしかして」フラグON
      }
    }

     // パターンB: まだなければ、入力を「カタカナ」にして検索
     // (例: ユーザーが「さくら」と入力 -> 「サクラ」で歌詞を探す)
    if (searchResults.length === 0) {
      const kataQuery = toKatakana(query);
      if (kataQuery !== query) {
        const kataResults = searchLyrics(data, kataQuery);
        if (kataResults.length > 0) {
          searchResults = kataResults;
          isFuzzy = true;
        }
      }
    }
  }

   // 3. ランダムな歌詞を1行取得
  const randomLyric = getRandomLyric(data);

  return {
    status: "success",
    query: query,
    is_fuzzy: isFuzzy,
    results: searchResults,
    random_message: randomLyric
  };
}

// 歌詞データの検索ロジック
function searchLyrics(data, keyword) {
  const results = [];
 
   // データを1行ずつチェック
  data.forEach(row => {
    const title = row[0];
    const lyricsFull = row[1];
   
    if (!lyricsFull) return;

     // 歌詞を行ごとに分割してチェック
    const lines = lyricsFull.split(/\r\n|\r|\n/);
   
    lines.forEach(line => {
       // 部分一致検索
      if (line.includes(keyword)) {
        results.push({
          title: title,
          phrase: line,
          display_text: `${line} （ ${title} ）`
        });
      }
    });
  });

  return results;
}

// ランダムに歌詞を1行抽出する
function getRandomLyric(data) {
  if (data.length === 0) return  "歌詞データがありません" ;
 
   // ランダムな曲を選ぶ
  const randomRow = data[Math.floor(Math.random() * data.length)];
  const lyricsFull = randomRow[1];
 
  if (!lyricsFull) return  "歌詞がありません" ;

   // その曲の中からランダムな1行を選ぶ
  const lines = lyricsFull.split(/\r\n|\r|\n/);
  const randomLine = lines[Math.floor(Math.random() * lines.length)];
 
  return `${randomLine} （ ${randomRow[0]} ）` ;
}

// === ユーティリティ関数群 (文字変換) ===

// カタカナ -> ひらがな
function toHiragana(src) {
  return src.replace(/[\u30a1-\u30f6]/g, function(match) {
    var chr = match.charCodeAt(0) - 0x60;
    return String.fromCharCode(chr);
  });
}

// ひらがな -> カタカナ
function toKatakana(src) {
  return src.replace(/[\u3041-\u3096]/g, function(match) {
    var chr = match.charCodeAt(0) + 0x60;
    return String.fromCharCode(chr);
  });
}
