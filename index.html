<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>aikotoba - aikoæ­Œè©æ¤œç´¢</title>
    <!-- Tailwind CSS (ãƒ‡ã‚¶ã‚¤ãƒ³ç”¨) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; }
        /* ãƒãƒ£ãƒƒãƒˆã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’éš ã™ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-orange-50 text-gray-800 h-screen flex flex-col">

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="bg-white p-4 shadow-sm flex items-center justify-center sticky top-0 z-10">
        <h1 class="text-xl font-bold text-orange-600 tracking-widest">aikotoba</h1>
    </header>

    <!-- ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ -->
    <main id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar pb-24">
        
        <!-- hokiã•ã‚“ (åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸) -->
        <div class="flex items-start space-x-2">
            <!-- ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒ: Twitteré€£å‹• (unavatar.io) -->
            <img src="https://unavatar.io/twitter/noki_dochibi" alt="hoki" class="w-10 h-10 rounded-full border border-gray-200">
            <div class="bg-white p-3 rounded-lg rounded-tl-none shadow-sm max-w-[80%]">
                <p class="text-sm">å¥½ããªãƒ•ãƒ¬ãƒ¼ã‚ºã‚’å…¥åŠ›ã—ã¦ã­ã€‚<br>aikoã®æ›²ã‹ã‚‰æ¢ã—ã¦ãã‚‹ã‚ˆï¼</p>
            </div>
        </div>

    </main>

    <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ -->
    <footer class="bg-white p-4 border-t border-gray-200 fixed bottom-0 w-full">
        <!-- ãƒ©ãƒ³ãƒ€ãƒ æ­Œè©è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="random-lyric-area" class="text-xs text-gray-400 text-center mb-2 h-4 truncate">
            <!-- ã“ã“ã«ãƒ©ãƒ³ãƒ€ãƒ ãªæ­Œè©ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ -->
        </div>

        <form id="search-form" class="flex gap-2">
            <input type="text" id="search-input" 
                class="flex-1 border border-gray-300 rounded-full px-4 py-2 focus:outline-none focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition"
                placeholder="ä¾‹: ç”˜ã„åŒ‚ã„ã«" required>
            <button type="submit" 
                class="bg-orange-500 text-white rounded-full px-6 py-2 font-bold hover:bg-orange-600 active:bg-orange-700 transition">
                é€ä¿¡
            </button>
        </form>
    </footer>

    <!-- ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ (ã‚³ãƒ”ãƒ¼å®Œäº†æ™‚) -->
    <div id="toast" class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs py-2 px-4 rounded-full opacity-0 transition-opacity duration-300 pointer-events-none">
        ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼
    </div>

    <script>
        // ==========================================
        // è¨­å®š: ã“ã“ã«GASã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªURLã‚’è²¼ã‚Šä»˜ã‘ã¾ã™
        // ==========================================
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycby49eACsPr_lGblpklhK13gt4TroRwNyKwnQcKQ3GPhACQ8zV96YZ9_CDXfFn5wOj85/exec"; 
        
        // Twitter IDè¨­å®š
        const TWITTER_ID = "noki_dochibi";
        const ICON_URL = `https://unavatar.io/twitter/${TWITTER_ID}`;

        const chatContainer = document.getElementById('chat-container');
        const searchForm = document.getElementById('search-form');
        const searchInput = document.getElementById('search-input');
        const randomArea = document.getElementById('random-lyric-area');
        const toast = document.getElementById('toast');

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡æ™‚ã®å‡¦ç†
        searchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const query = searchInput.value.trim();
            if (!query) return;

            // 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¹ãå‡ºã—ã‚’è¿½åŠ 
            addMessage(query, 'user');
            searchInput.value = '';

            // 2. ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            const loadingId = addLoading();

            try {
                // 3. GASã¸æ¤œç´¢ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                // GASã¯ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’è¿”ã™ãŸã‚ã€redirect: 'follow' ãŒé‡è¦
                const response = await fetch(`${GAS_API_URL}?q=${encodeURIComponent(query)}`);
                const data = await response.json();

                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å‰Šé™¤
                removeLoading(loadingId);

                // 4. çµæœã®è¡¨ç¤º
                if (data.status === 'success') {
                    handleSearchResults(data);
                } else {
                    addMessage("ã”ã‚ã‚“ã­ã€ã†ã¾ãæ¢ã›ãªã‹ã£ãŸã¿ãŸã„... (ã‚¨ãƒ©ãƒ¼)", 'bot');
                }

            } catch (error) {
                removeLoading(loadingId);
                console.error(error);
                addMessage("é€šä¿¡ã«å¤±æ•—ã—ã¡ã‚ƒã£ãŸã€‚ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ã¿ã¦ï¼", 'bot');
            }
        });

        // æ¤œç´¢çµæœã®å‡¦ç†
        function handleSearchResults(data) {
            // ãƒ©ãƒ³ãƒ€ãƒ æ­Œè©ã®æ›´æ–°
            if (data.random_message) {
                randomArea.textContent = data.random_message;
            }

            // çµæœãŒãªã„å ´åˆ
            if (data.results.length === 0) {
                addMessage(`ã€Œ${data.query}ã€ã¯è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸã‚ˆ...ğŸ’¦`, 'bot');
                return;
            }

            // ã‚‚ã—ã‹ã—ã¦æ¤œç´¢ã®å ´åˆ
            if (data.is_fuzzy) {
                addMessage(`ã€Œ${data.query}ã€ã¯è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸã‘ã©...<br>ã‚‚ã—ã‹ã—ã¦ã€ã“ã‚Œã‹ãªï¼Ÿ`, 'bot');
            }

            // çµæœã‚’å¹ãå‡ºã—ã§è¡¨ç¤º (è¤‡æ•°ã‚ã‚‹å ´åˆã¯ã¾ã¨ã‚ã¦è¡¨ç¤ºã™ã‚‹ã‹ã€å€‹åˆ¥ã«ã™ã‚‹ã‹ã€‚ä»Šå›ã¯å€‹åˆ¥ã«è¡¨ç¤º)
            data.results.forEach(item => {
                addResultBubble(item.display_text);
            });
        }

        // å¹ãå‡ºã—è¿½åŠ é–¢æ•° (type: 'user' | 'bot')
        function addMessage(text, type) {
            const div = document.createElement('div');
            div.className = `flex items-start space-x-2 ${type === 'user' ? 'justify-end' : ''}`;

            const iconHtml = type === 'bot' 
                ? `<img src="${ICON_URL}" class="w-10 h-10 rounded-full border border-gray-200">` 
                : '';
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã‚ªãƒ¬ãƒ³ã‚¸ã€Botã¯ç™½
            const bgClass = type === 'user' ? 'bg-orange-500 text-white rounded-tr-none' : 'bg-white text-gray-800 rounded-tl-none';
            const contentHtml = `
                <div class="${bgClass} p-3 rounded-lg shadow-sm max-w-[80%] text-sm break-words">
                    ${text}
                </div>
            `;

            div.innerHTML = type === 'bot' ? iconHtml + contentHtml : contentHtml;
            chatContainer.appendChild(div);
            scrollToBottom();
        }

        // çµæœç”¨ãƒãƒ–ãƒ«ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§ã‚³ãƒ”ãƒ¼ï¼‰
        function addResultBubble(text) {
            const div = document.createElement('div');
            div.className = "flex items-start space-x-2";
            
            // ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ã‚’ä»˜ä¸
            const bubbleId = 'res-' + Date.now() + Math.random();
            
            div.innerHTML = `
                <img src="${ICON_URL}" class="w-10 h-10 rounded-full border border-gray-200 opacity-50"> <!-- çµæœã¯ã¡ã‚‡ã£ã¨ã‚¢ã‚¤ã‚³ãƒ³è–„ãã™ã‚‹ç­‰ã®æ¼”å‡ºã‚‚å¯ -->
                <div onclick="copyToClipboard('${text.replace(/'/g, "\\'")}')" 
                     class="bg-white border-2 border-orange-100 text-gray-800 p-3 rounded-lg rounded-tl-none shadow-sm max-w-[80%] cursor-pointer hover:bg-orange-50 active:bg-orange-100 transition relative group">
                    <p class="text-sm font-bold">${text}</p>
                    <span class="absolute right-2 bottom-1 text-[10px] text-gray-400 opacity-0 group-hover:opacity-100 transition">ã‚¿ãƒƒãƒ—ã—ã¦ã‚³ãƒ”ãƒ¼</span>
                </div>
            `;
            chatContainer.appendChild(div);
            scrollToBottom();
        }

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
        function addLoading() {
            const id = 'loading-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = "flex items-start space-x-2";
            div.innerHTML = `
                <img src="${ICON_URL}" class="w-10 h-10 rounded-full border border-gray-200">
                <div class="bg-white p-3 rounded-lg rounded-tl-none shadow-sm">
                    <div class="flex space-x-1">
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce delay-75"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce delay-150"></div>
                    </div>
                </div>
            `;
            chatContainer.appendChild(div);
            scrollToBottom();
            return id;
        }

        function removeLoading(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‚³ãƒ”ãƒ¼
        function copyToClipboard(text) {
            // ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆHTMLã‚¿ã‚°ç­‰ã‚’é™¤ãï¼‰
            const cleanText = text.replace(/<br>/g, '\n');
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(cleanText).then(() => showToast());
            } else {
                // å¤ã„ãƒ–ãƒ©ã‚¦ã‚¶ç­‰ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                const textarea = document.createElement('textarea');
                textarea.value = cleanText;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showToast();
            }
        }

        function showToast() {
            toast.classList.remove('opacity-0');
            setTimeout(() => {
                toast.classList.add('opacity-0');
            }, 2000);
        }
    </script>
</body>
</html>
