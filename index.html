<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <!-- 
      viewportè¨­å®š: 
      ãƒ”ãƒ³ãƒã‚¤ãƒ³ãƒ»ã‚¢ã‚¦ãƒˆç„¡åŠ¹åŒ– (user-scalable=no)
    -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>aikotoba - aikoæ­Œè©æ¤œç´¢</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; }
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼éè¡¨ç¤º */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* ãƒœã‚¿ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .send-btn-active:active { transform: scale(0.9); }

        /* iPhone Safe Areaå¯¾ç­– */
        .safe-pb {
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆç‚¹æ»…ï¼‰ */
        .pulse-text {
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }

        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã®èª¿æ•´ã‚¯ãƒ©ã‚¹ */
        .message-row {
            scroll-margin-top: 5rem;
        }

        /* v0.1.9 è¿½åŠ : 
           æ¤œç´¢çµæœãŒã€Œãšã‚‰ã‚‰ã‚‰â€¦ã€ã¨è¡¨ç¤ºã•ã‚Œã‚‹ãŸã‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®šç¾©
        */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-slide-in {
            opacity: 0; /* åˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤º */
            animation: slideIn 0.4s ease-out forwards;
        }
    </style>
</head>
<body class="bg-orange-50 text-gray-800 h-screen flex flex-col">

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="bg-white/90 backdrop-blur-sm p-3 shadow-sm flex items-center justify-center sticky top-0 z-10 border-b border-orange-100">
        <h1 class="text-lg font-bold text-orange-600 tracking-wider flex items-baseline">
            aikotoba
            <!-- ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¡¨ç¤º -->
            <span id="version-display" class="ml-2 text-[10px] text-gray-400 font-normal opacity-50"></span>
        </h1>
    </header>

    <!-- ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ -->
    <main id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar pb-40"> 
        
        <!-- hokiã•ã‚“ (åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸) -->
        <div class="flex items-start space-x-2">
            <img id="bot-icon-initial" src="" alt="hoki" class="w-10 h-10 rounded-full border border-gray-200 bg-white">
            <div class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm max-w-[80%]">
                <p class="text-sm leading-relaxed">å¥½ããªãƒ•ãƒ¬ãƒ¼ã‚ºã‚’å…¥åŠ›ã—ã¦ã­ã€‚<br>aikoã®æ›²ã‹ã‚‰æ¢ã—ã¦ãã‚‹ã‚ˆï¼</p>
            </div>
        </div>

    </main>

    <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ -->
    <footer class="bg-white px-3 py-2 border-t border-gray-100 fixed bottom-0 w-full safe-pb" style="padding-bottom: calc(env(safe-area-inset-bottom) + 20px);">
        <!-- ãƒ©ãƒ³ãƒ€ãƒ æ­Œè©è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="random-lyric-area" class="text-[10px] text-gray-400 text-center mb-1 h-4 truncate"></div>

        <form id="search-form" class="flex items-center gap-2">
            <div class="flex-1 bg-gray-100 rounded-full flex items-center px-4 py-2">
                <input type="text" id="search-input" 
                    class="flex-1 bg-transparent border-none focus:outline-none text-sm placeholder-gray-400"
                    placeholder="ä¾‹ï¼šç”˜ã„åŒ‚ã„ã«" required autocomplete="off">
            </div>
            
            <button type="submit" 
                class="send-btn-active text-orange-500 p-2 rounded-full hover:bg-orange-50 transition flex-shrink-0">
                <i data-lucide="send" class="w-6 h-6 fill-current"></i>
            </button>
        </form>
    </footer>

    <!-- ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ -->
    <div id="toast" class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-gray-800/80 backdrop-blur text-white text-xs py-2 px-4 rounded-full opacity-0 transition-opacity duration-300 pointer-events-none z-50 shadow-lg">
        ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼
    </div>

    <script>
        // ==========================================
        // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†
        // ==========================================
        const APP_VERSION = 'v0.1.9';

        // ==========================================
        // è¨­å®š
        // ==========================================
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycby49eACsPr_lGblpklhK13gt4TroRwNyKwnQcKQ3GPhACQ8zV96YZ9_CDXfFn5wOj85/exec"; 
        const TWITTER_ID = "noki_dochibi";
        const ICON_URL = `https://unavatar.io/twitter/${TWITTER_ID}?v=${APP_VERSION}`;

        // å¾…æ©Ÿä¸­ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒˆ
        const LOADING_MESSAGES = [
            "aikoã®ãƒã‚±ãƒƒãƒˆã®ä¸­ã‚’æ¢ã—ã¦ã„ã¾ã™...",
            "æ­Œè©ã®æ˜Ÿå±‘ã‚’é›†ã‚ã¦ã„ã¾ã™...",
            "ç§˜å¯†ã®ãƒãƒ¼ãƒˆã‚’ã‚ãã£ã¦ã„ã¾ã™...",
            "ãƒ†ãƒˆãƒ©ãƒãƒƒãƒˆã®è£å´ã‚’ç¢ºèªä¸­...",
            "ã‚«ãƒ–ãƒˆãƒ ã‚·ã«èã„ã¦ã„ã¾ã™...",
            "æ·±å¤œ2æ™‚ã®æœ¬éŸ³ã‚’æ¢ã—ã¦ã„ã¾ã™...",
            "èŠ±ç«ã®æ®‹åƒã‚’è¿½ã„ã‹ã‘ã¦ã„ã¾ã™..."
        ];

        const chatContainer = document.getElementById('chat-container');
        const searchForm = document.getElementById('search-form');
        const searchInput = document.getElementById('search-input');
        const randomArea = document.getElementById('random-lyric-area');
        const toast = document.getElementById('toast');
        const versionDisplay = document.getElementById('version-display');

        // åˆæœŸåŒ–
        window.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            if (versionDisplay) versionDisplay.textContent = APP_VERSION;
            const initialIcon = document.getElementById('bot-icon-initial');
            if (initialIcon) initialIcon.src = ICON_URL;
            const preloadImg = new Image();
            preloadImg.src = ICON_URL;
        });

        // é€ä¿¡å‡¦ç†
        searchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const query = searchInput.value.trim();
            if (!query) return;

            addMessage(query, 'user');
            searchInput.value = '';

            const loadingId = addLoading();

            try {
                const response = await fetch(`${GAS_API_URL}?q=${encodeURIComponent(query)}`);
                const data = await response.json();

                removeLoading(loadingId);

                if (data.status === 'success') {
                    handleSearchResults(data);
                } else {
                    addMessage("ã”ã‚ã‚“ã­ã€ã†ã¾ãæ¢ã›ãªã‹ã£ãŸã¿ãŸã„... (ã‚¨ãƒ©ãƒ¼)", 'bot');
                }

            } catch (error) {
                removeLoading(loadingId);
                console.error(error);
                addMessage("é€šä¿¡ã«å¤±æ•—ã—ã¡ã‚ƒã£ãŸã€‚ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ã¿ã¦ï¼", 'bot');
            }
        });

        function handleSearchResults(data) {
            if (data.random_message) {
                randomArea.textContent = 'ãƒ©ãƒ³ãƒ€ãƒ è¡¨ç¤ºï¼š' + data.random_message;
            }

            if (data.results.length === 0) {
                addMessage(`ã€Œ${data.query}ã€ã¯è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸã‚ˆ...ğŸ’¦`, 'bot');
                return;
            }

            if (data.is_fuzzy) {
                addMessage(`ã€Œ${data.query}ã€ã¯è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸã‘ã©...<br>ã‚‚ã—ã‹ã—ã¦ã€ã“ã‚Œã‹ãªï¼Ÿ`, 'bot');
            }

            // ==========================================
            // çµæœè¡¨ç¤º: ãšã‚‰ã‚‰ã‚‰â€¦ã¨è¡¨ç¤ºã™ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ã
            // ==========================================
            let contentHtml = '<div class="flex flex-col space-y-3">';
            
            data.results.forEach((item, index) => {
                // indexã‚’ä½¿ã£ã¦é…å»¶æ™‚é–“ï¼ˆmsï¼‰ã‚’è¨ˆç®—ã€‚1ã¤ã«ã¤ã0.1ç§’ãšã¤é…ã‚‰ã›ã‚‹
                const delay = index * 100;

                contentHtml += `
                    <div style="animation-delay: ${delay}ms" 
                         onclick="copyToClipboard('${item.display_text.replace(/'/g, "\\'")}')" 
                         class="animate-slide-in bg-orange-50/50 border border-orange-100 rounded-xl p-3 cursor-pointer hover:bg-orange-100 transition relative group select-none">
                        <p class="text-sm font-bold text-gray-800 leading-relaxed">${item.display_text}</p>
                        <div class="flex justify-end items-center mt-2">
                            <!-- ãƒ†ã‚­ã‚¹ãƒˆã‚’å‰Šé™¤ã—ã€ã‚¢ã‚¤ã‚³ãƒ³ã®ã¿è¡¨ç¤º -->
                            <span class="text-orange-400 opacity-70 group-hover:opacity-100 transition p-1">
                                <i data-lucide="copy" class="w-4 h-4"></i>
                            </span>
                        </div>
                    </div>
                `;
            });
            
            contentHtml += '</div>';
            
            // ä»¶æ•°è¡¨ç¤ºï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«è¦‹ãˆã‚‹ã‚ˆã†ã«å°‘ã—é…å»¶ï¼‰
            const footerDelay = data.results.length * 100;
            
            // ä»¶æ•°ã¨ãƒœã‚¿ãƒ³ã‚‚ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¯¾è±¡ã«ã™ã‚‹
            contentHtml += `
                <div style="animation-delay: ${footerDelay}ms" class="animate-slide-in">
                    <p class="mt-3 text-[10px] text-gray-400 text-right">
                        ä¸Šè¨˜${data.results.length}ç®‡æ‰€ã®ãƒ•ãƒ¬ãƒ¼ã‚ºã§è¦‹ã¤ã‹ã£ãŸã‚ˆâ™ª
                    </p>
                    <div class="mt-4 flex justify-center border-t border-gray-100 pt-2">
                        <button onclick="this.closest('.message-row').scrollIntoView({behavior:'smooth', block:'start'})" 
                                class="text-[10px] text-orange-400 hover:text-orange-600 flex items-center gap-1 transition px-2 py-1 rounded-full hover:bg-orange-50">
                            <i data-lucide="arrow-up" class="w-3 h-3"></i> ã“ã®å›ç­”ã®ãƒˆãƒƒãƒ—ã¸ç§»å‹•
                        </button>
                    </div>
                </div>
            `;

            addMessage(contentHtml, 'bot');
            lucide.createIcons();
        }

        function addMessage(htmlOrText, type) {
            const div = document.createElement('div');
            div.className = `flex items-start space-x-2 message-row ${type === 'user' ? 'justify-end' : ''}`;

            const iconHtml = type === 'bot' 
                ? `<img src="${ICON_URL}" class="w-10 h-10 rounded-full border border-gray-200 bg-white flex-shrink-0">` 
                : '';
            
            const bgClass = type === 'user' ? 'bg-orange-500 text-white rounded-tr-none' : 'bg-white text-gray-800 rounded-tl-none';
            
            const contentHtml = `
                <div class="${bgClass} px-3 py-2 rounded-2xl shadow-sm max-w-[85%] text-sm break-words leading-relaxed">
                    ${htmlOrText}
                </div>
            `;

            div.innerHTML = type === 'bot' ? iconHtml + contentHtml : contentHtml;
            chatContainer.appendChild(div);
            scrollToBottom();
        }

        function addLoading() {
            const id = 'loading-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = "flex items-start space-x-2";
            
            const randomMsg = LOADING_MESSAGES[Math.floor(Math.random() * LOADING_MESSAGES.length)];

            div.innerHTML = `
                <img src="${ICON_URL}" class="w-10 h-10 rounded-full border border-gray-200 bg-white flex-shrink-0">
                <div class="bg-white px-4 py-3 rounded-2xl rounded-tl-none shadow-sm">
                    <p class="text-sm text-gray-500 pulse-text">
                        ${randomMsg}
                    </p>
                </div>
            `;
            chatContainer.appendChild(div);
            scrollToBottom();
            return id;
        }

        function removeLoading(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function copyToClipboard(text) {
            const cleanText = text.replace(/<br>/g, '\n');
            if (navigator.clipboard) {
                navigator.clipboard.writeText(cleanText).then(() => showToast());
            } else {
                const textarea = document.createElement('textarea');
                textarea.value = cleanText;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showToast();
            }
        }

        function showToast() {
            toast.classList.remove('opacity-0');
            setTimeout(() => {
                toast.classList.add('opacity-0');
            }, 2000);
        }
    </script>
</body>
</html>
