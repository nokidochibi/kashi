<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>aikotoba - aikoæ­Œè©æ¤œç´¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        
        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç‚¹æ»… */
        .pulse-text { animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }

        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®èª¿æ•´ */
        .message-row { scroll-margin-top: 5rem; }

        /* ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }

        /* ãƒã‚¤ãƒ©ã‚¤ãƒˆè£…é£¾ */
        .highlight-text {
            color: #ea580c; /* orange-600 */
            font-weight: bold;
            background-color: #fff7ed; /* orange-50 */
            border-bottom: 2px solid #fdba74; /* orange-300 */
            padding: 0 2px;
        }

        /* ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã®ç‚¹ç·šåŒºåˆ‡ã‚Š */
        .result-item {
            border-bottom: 1px dashed #fed7aa; /* orange-200 */
        }
        .result-item:last-child {
            border-bottom: none;
        }
        
        /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ™‚ã®ã‚¯ãƒªãƒƒã‚¯æ„Ÿ */
        .active-tap:active {
            background-color: #fff7ed; /* orange-50 */
        }
    </style>
</head>
<body class="bg-orange-50 text-gray-800 h-screen flex flex-col">

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="bg-white/90 backdrop-blur-sm p-3 shadow-sm flex items-center justify-center sticky top-0 z-10 border-b border-orange-100 relative">
        <h1 class="text-lg font-bold text-orange-600 tracking-wider flex items-baseline">
            aikotoba
            <span id="version-display" class="ml-2 text-[10px] text-gray-400 font-normal opacity-50"></span>
        </h1>
        <button onclick="toggleModal(true)" class="absolute right-4 text-orange-400 hover:text-orange-600 transition p-1 rounded-full hover:bg-orange-50">
            <i data-lucide="help-circle" class="w-6 h-6"></i>
        </button>
    </header>

    <!-- ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ -->
    <main id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar pb-40"> 
        <div class="flex items-start space-x-2">
            <img id="bot-icon-initial" src="" alt="hoki" class="w-10 h-10 rounded-full border border-gray-200 bg-white">
            <div class="bg-white p-3 rounded-2xl rounded-tl-none shadow-sm max-w-[80%]">
                <p class="text-sm leading-relaxed">å¥½ããªãƒ•ãƒ¬ãƒ¼ã‚ºã‚’å…¥åŠ›ã—ã¦ã­ã€‚<br>aikoã®æ›²ã‹ã‚‰æ¢ã—ã¦ãã‚‹ã‚ˆï¼</p>
            </div>
        </div>
    </main>

    <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ -->
    <footer class="bg-white px-3 py-2 border-t border-gray-100 fixed bottom-0 w-full safe-pb" style="padding-bottom: calc(env(safe-area-inset-bottom) + 20px);">
        <div id="random-lyric-area" class="text-[10px] text-gray-400 text-center mb-1 h-4 truncate"></div>
        <form id="search-form" class="flex items-center gap-2">
            <div class="flex-1 bg-gray-100 rounded-full flex items-center px-4 py-2">
                <input type="text" id="search-input" 
                    class="flex-1 bg-transparent border-none focus:outline-none text-sm placeholder-gray-400"
                    placeholder="ä¾‹ï¼šç”˜ã„åŒ‚ã„ã«" required autocomplete="off">
            </div>
            <button type="submit" class="text-orange-500 p-2 rounded-full hover:bg-orange-50 transition flex-shrink-0 active:scale-95">
                <i data-lucide="send" class="w-6 h-6 fill-current"></i>
            </button>
        </form>
    </footer>

    <!-- ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ -->
    <div id="toast" class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-gray-800/90 backdrop-blur text-white text-xs py-2 px-6 rounded-full opacity-0 transition-opacity duration-300 pointer-events-none z-50 shadow-lg font-bold tracking-wide">
        ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼
    </div>

    <!-- Readme ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="readme-modal" class="fixed inset-0 z-50 hidden" aria-hidden="true">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onclick="toggleModal(false)"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white w-[90%] max-w-sm rounded-2xl shadow-xl p-6 transition-all">
            <div class="flex justify-between items-start mb-4">
                <h2 class="text-lg font-bold text-orange-600 flex items-center gap-2">
                    <i data-lucide="info" class="w-5 h-5"></i> ä½¿ã„æ–¹
                </h2>
                <button onclick="toggleModal(false)" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="space-y-4 text-sm text-gray-700 leading-relaxed overflow-y-auto max-h-[60vh]">
                <section>
                    <p>å¥½ããªãƒ•ãƒ¬ãƒ¼ã‚ºã‚’å…¥åŠ›ã—ã¦é€ä¿¡ã—ã¦ãã ã•ã„ã€‚aikoã®å…¨æ¥½æ›²ã‹ã‚‰æ¢ã—ã¾ã™ã€‚</p>
                </section>
                <section class="bg-orange-50 p-3 rounded-xl border border-orange-100">
                    <h3 class="font-bold text-orange-700 mb-1 text-xs">ğŸ’¡ ã‚‚ã—ã‹ã—ã¦æ¤œç´¢</h3>
                    <p class="text-xs">
                        è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€è‡ªå‹•ã§<b>ã€Œã²ã‚‰ãŒãªã€ã€Œã‚«ã‚¿ã‚«ãƒŠã€</b>ã«å¤‰æ›ã—ã¦æ¢ã—ã¾ã™ã€‚<br>
                        ã¾ãŸã€<b>ã€Œãã ã•ã„ â‡” ä¸‹ã•ã„ã€</b>ãªã©ã®ã‚ˆãã‚ã‚‹é•ã„ã‚‚è‡ªå‹•ã§ã‚«ãƒãƒ¼ã—ã¾ã™ã€‚
                    </p>
                </section>
            </div>
            <button onclick="toggleModal(false)" class="mt-6 w-full bg-orange-500 text-white font-bold py-3 rounded-xl shadow-md hover:bg-orange-600 transition">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <script>
        const APP_VERSION = 'v0.1.14';
        // â˜…ã“ã“ã«æ–°ã—ã„GASã®ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªURLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
        const GAS_API_URL = "YOUR_NEW_GAS_URL_HERE"; 
        
        const TWITTER_ID = "noki_dochibi";
        const ICON_URL = `https://unavatar.io/twitter/${TWITTER_ID}?v=${APP_VERSION}`;
        const LOADING_MESSAGES = [
            "aikoã®ãƒã‚±ãƒƒãƒˆã®ä¸­ã‚’æ¢ã—ã¦ã„ã¾ã™...", "æ­Œè©ã®æ˜Ÿå±‘ã‚’é›†ã‚ã¦ã„ã¾ã™...", "ç§˜å¯†ã®ãƒãƒ¼ãƒˆã‚’ã‚ãã£ã¦ã„ã¾ã™...",
            "ãƒ†ãƒˆãƒ©ãƒãƒƒãƒˆã®è£å´ã‚’ç¢ºèªä¸­...", "ã‚«ãƒ–ãƒˆãƒ ã‚·ã«èã„ã¦ã„ã¾ã™...", "æ·±å¤œ2æ™‚ã®æœ¬éŸ³ã‚’æ¢ã—ã¦ã„ã¾ã™..."
        ];

        const chatContainer = document.getElementById('chat-container');
        const searchForm = document.getElementById('search-form');
        const searchInput = document.getElementById('search-input');
        const randomArea = document.getElementById('random-lyric-area');
        const toast = document.getElementById('toast');
        const versionDisplay = document.getElementById('version-display');
        const readmeModal = document.getElementById('readme-modal');

        window.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            if (versionDisplay) versionDisplay.textContent = APP_VERSION;
            const initialIcon = document.getElementById('bot-icon-initial');
            if (initialIcon) initialIcon.src = ICON_URL;
        });

        function toggleModal(show) {
            readmeModal.classList.toggle('hidden', !show);
        }

        searchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const query = searchInput.value.trim();
            if (!query) return;

            addMessage(query, 'user');
            searchInput.value = '';
            const loadingId = addLoading();

            try {
                const response = await fetch(`${GAS_API_URL}?q=${encodeURIComponent(query)}`);
                const data = await response.json();
                removeLoading(loadingId);

                if (data.status === 'success') {
                    handleSearchResults(data);
                } else {
                    addMessage("ã”ã‚ã‚“ã­ã€ã†ã¾ãæ¢ã›ãªã‹ã£ãŸã¿ãŸã„... (ã‚¨ãƒ©ãƒ¼)", 'bot');
                }
            } catch (error) {
                removeLoading(loadingId);
                console.error(error);
                addMessage("é€šä¿¡ã«å¤±æ•—ã—ã¡ã‚ƒã£ãŸã€‚ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ã¿ã¦ï¼", 'bot');
            }
        });

        function handleSearchResults(data) {
            if (data.random_message) randomArea.textContent = 'ãƒ©ãƒ³ãƒ€ãƒ è¡¨ç¤ºï¼š' + data.random_message;

            if (data.results.length === 0) {
                addMessage(`ã€Œ${data.query}ã€ã¯è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸã‚ˆ...ğŸ’¦`, 'bot');
                return;
            }

            if (data.is_fuzzy) {
                addMessage(`ã€Œ${data.query}ã€ã¯è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸã‘ã©...<br>ã‚‚ã—ã‹ã—ã¦ã€ã“ã‚Œã‹ãªï¼Ÿ`, 'bot');
            }

            // === çµæœè¡¨ç¤ºãƒªã‚¹ãƒˆç”Ÿæˆ (ç‚¹ç·šåŒºåˆ‡ã‚Šãƒ»çœã‚¹ãƒšãƒ¼ã‚¹) ===
            // ãƒã‚¤ãƒ©ã‚¤ãƒˆç”¨ã®æ­£è¦è¡¨ç¾ã‚’ä½œæˆ
            const escapeRegExp = (string) => string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            // ãƒ’ãƒƒãƒˆã—ãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰(matched_keyword)ã‹ã€å…¥åŠ›ã—ãŸã‚¯ã‚¨ãƒª(query)ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            const highlightTerm = data.matched_keyword || data.query;
            const highlightRegex = new RegExp(`(${escapeRegExp(highlightTerm)})`, 'gi');

            let listHtml = '<div class="bg-white rounded-2xl shadow-sm border border-orange-100 overflow-hidden animate-fade-in text-left">';
            
            data.results.forEach((item) => {
                // ãƒã‚¤ãƒ©ã‚¤ãƒˆå‡¦ç†
                const highlightedPhrase = item.raw_line.replace(highlightRegex, '<span class="highlight-text">$1</span>');
                
                // ã‚³ãƒ”ãƒ¼ç”¨ãƒ†ã‚­ã‚¹ãƒˆ(æ›²åå«ã‚€)
                const copyText = `${item.raw_line} ï¼ˆ ${item.title} ï¼‰`;

                listHtml += `
                    <div onclick="copyToClipboard('${copyText.replace(/'/g, "\\'")}')" 
                         class="result-item p-3 cursor-pointer active-tap transition group">
                        <p class="text-sm text-gray-800 leading-relaxed">
                            ${highlightedPhrase}
                            <span class="text-xs text-orange-400 ml-1 font-normal block mt-1">
                                ï¼ˆ ${item.title} ï¼‰
                            </span>
                        </p>
                    </div>
                `;
            });
            listHtml += '</div>';
            
            // ãƒ•ãƒƒã‚¿ãƒ¼
            listHtml += `
                <div class="mt-2 flex justify-between items-center animate-fade-in px-1">
                    <span class="text-[10px] text-gray-300">ã‚¿ãƒƒãƒ—ã§ã‚³ãƒ”ãƒ¼</span>
                    <button onclick="this.closest('.message-row').scrollIntoView({behavior:'smooth', block:'start'})" 
                            class="text-[10px] text-orange-400 hover:text-orange-600 flex items-center gap-1 transition px-2 py-1 rounded-full hover:bg-orange-50">
                        <i data-lucide="arrow-up" class="w-3 h-3"></i> Top
                    </button>
                </div>
            `;

            addMessage(listHtml, 'bot', true);
            lucide.createIcons();
        }

        function addMessage(htmlOrText, type, shouldScroll = true) {
            const div = document.createElement('div');
            div.className = `flex items-start space-x-2 message-row ${type === 'user' ? 'justify-end' : ''}`;
            const iconHtml = type === 'bot' 
                ? `<img src="${ICON_URL}" class="w-10 h-10 rounded-full border border-gray-200 bg-white flex-shrink-0">` : '';
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼å´ã®å¹ãå‡ºã—ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ã€Botå´ã¯HTMLã‚’ãã®ã¾ã¾è¡¨ç¤ºã™ã‚‹ãŸã‚ã‚³ãƒ³ãƒ†ãƒŠã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’èª¿æ•´
            const bubbleClass = type === 'user' 
                ? 'bg-orange-500 text-white rounded-2xl rounded-tr-none px-3 py-2 shadow-sm max-w-[85%]' 
                : 'w-full max-w-[90%]'; // Botå´ã¯å¹…ã‚’åºƒãã¨ã‚‹

            let contentHtml;
            if (type === 'user') {
                contentHtml = `<div class="${bubbleClass} text-sm break-words">${htmlOrText}</div>`;
            } else {
                // Botã®å ´åˆã¯çµæœãƒªã‚¹ãƒˆ(HTML)ãŒæ¸¡ã£ã¦ãã‚‹ã®ã§ã€ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ãªã—ã®ã‚³ãƒ³ãƒ†ãƒŠã«å…¥ã‚Œã‚‹
                contentHtml = `<div class="${bubbleClass}">${htmlOrText}</div>`;
            }

            div.innerHTML = type === 'bot' ? iconHtml + contentHtml : contentHtml;
            chatContainer.appendChild(div);
            if (shouldScroll) scrollToBottom();
        }

        function addLoading() {
            const id = 'loading-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = "flex items-start space-x-2";
            const randomMsg = LOADING_MESSAGES[Math.floor(Math.random() * LOADING_MESSAGES.length)];
            div.innerHTML = `
                <img src="${ICON_URL}" class="w-10 h-10 rounded-full border border-gray-200 bg-white flex-shrink-0">
                <div class="bg-white px-4 py-3 rounded-2xl rounded-tl-none shadow-sm border border-gray-100">
                    <p class="text-sm text-gray-500 pulse-text">${randomMsg}</p>
                </div>
            `;
            chatContainer.appendChild(div);
            scrollToBottom();
            return id;
        }

        function removeLoading(id) { const el = document.getElementById(id); if(el) el.remove(); }
        function scrollToBottom() { chatContainer.scrollTop = chatContainer.scrollHeight; }

        function copyToClipboard(text) {
            const cleanText = text.replace(/<br>/g, '\n');
            if (navigator.clipboard) {
                navigator.clipboard.writeText(cleanText).then(() => showToast());
            } else {
                const textarea = document.createElement('textarea');
                textarea.value = cleanText;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showToast();
            }
        }

        function showToast() {
            toast.classList.remove('opacity-0');
            setTimeout(() => toast.classList.add('opacity-0'), 2000);
        }
    </script>
</body>
</html>
